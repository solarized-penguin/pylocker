version: "3.7"
services:

  fusion_db:
    image: postgres:latest
    container_name: fusion_db
    env_file:
      - ../env_vars/fusionauth/dev.env
    environment:
      PGDATA: ${FUSION_DB_DATA}
      POSTGRES_USER: ${FUSION_DB_USER}
      POSTGRES_PASSWORD: ${FUSION_DB_PASSWORD}
    ports:
      - ${FUSION_DB_PORT}:5432
    networks:
      - fusion_net
    restart: unless-stopped
    volumes:
      - fusion_data:/var/lib/postgresql/data
      
  fusionauth:
    image: fusionauth/fusionauth-app:latest
    container_name: fusionauth
    depends_on:
      - fusion_db
    env_file:
      - ../env_vars/fusionauth/dev.env
    environment:
      DATABASE_URL: ${FUSION_API_DB_URL}
      DATABASE_ROOT_USERNAME: ${FUSION_DB_USER}
      DATABASE_ROOT_PASSWORD: ${FUSION_DB_PASSWORD}
      DATABASE_USERNAME: ${FUSION_API_DB_USERNAME}
      DATABASE_PASSWORD: ${FUSION_API_DB_PASSWORD}
      FUSIONAUTH_APP_MEMORY: ${FUSION_API_MEMORY}
      SEARCH_TYPE: ${FUSION_API_SEARCH_TYPE}
      FUSIONAUTH_APP_URL: ${FUSION_API_URL}
    networks:
      - fusion_net
      - pylocker_net
    restart: unless-stopped
    ports:
      - ${FUSION_API_PORT}:9011
    volumes:
      - fa_config:/usr/local/fusionauth/config

  pylocker_db:
    image: postgres:latest
    container_name: pylocker_db
    env_file:
      - ../env_vars/pylocker/dev.env
    environment:
      PGDATA: ${PYLOCKER_DB_DATA}
      POSTGRES_USER: ${PYLOCKER_DB_USER}
      POSTGRES_PASSWORD: ${PYLOCKER_DB_PASSWORD}
      POSTGRES_DB: ${PYLOCKER_DB_NAME}
    ports:
      - ${PYLOCKER_DB_PORT}:5432
    volumes:
      - pylocker_data:${PYLOCKER_DB_DATA}
    restart: unless-stopped
    networks:
      - pylocker_net

  pylocker:
    container_name: pylocker
    env_file:
      - ../env_vars/pylocker/dev.env
    build:
      context: .
      dockerfile: ./Dockerfile
    depends_on:
      - pylocker_db
    ports:
      - ${APP_PORT}:80
    networks:
      - pylocker_net
    restart: unless-stopped

networks:
  pylocker_net:
    name: pylocker_net
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 192.168.52.0/24
  fusion_net:
    name: fusion_net
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 192.168.53.0/24

volumes:
  pylocker_data:
  fusion_data:
  fa_config:
